- name: Create a db on MSSQL
  hosts: all
  gather_facts: no

  tasks:
    - name: Set windows connection variables
      set_fact:
        hostvars["{{ inventory_hostname }}"]["ansible_port"]: 5986
        hostvars["{{ inventory_hostname }}"]["ansible_connection"]: winrm
        hostvars["{{ inventory_hostname }}"]["ansible_winrm_transport"]: credssp
        hostvars["{{ inventory_hostname }}"]["ansible_winrm_server_cert_validation"]: ignore

    - name: Enable port for MSSQL
      win_firewall_rule:
        name: MSSQL
        localport: 1433
        action: allow
        direction: in
        protocol: tcp
        profiles: public
        state: present
        enabled: yes

    - name: Create a db
      mssql_db:
        login_host: "{{ ansible_ssh_host | default(inventory_hostname) }}"
        login_user: sa
        login_password: Password1!
        name: redhatdemo2
        state: present
      delegate_to: 127.0.0.1